<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kclm.xsap.mapper.TMemberMapper">
  <resultMap id="TMemberMap" type="com.kclm.xsap.entity.TMember">
    <!--@mbg.generated-->
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="sex" jdbcType="VARCHAR" property="sex" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="birthday" jdbcType="DATE" property="birthday" />
    <result column="note" jdbcType="VARCHAR" property="note" />
    <result column="avatar_url" jdbcType="VARCHAR" property="avatarUrl" />
    <result column="is_deleted" jdbcType="BOOLEAN" property="isDeleted" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="last_modify_time" jdbcType="TIMESTAMP" property="lastModifyTime" />
    <result column="version" jdbcType="INTEGER" property="version" />
  </resultMap>

  <!-- 会员的VO数据 -->
  <resultMap id="MemberViewMap" type="com.kclm.xsap.dto.MemberVO">
  	<id column="id" jdbcType="BIGINT" property="id" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="sex" jdbcType="VARCHAR" property="gender" />
    <result column="phone" jdbcType="VARCHAR" property="phone" />
    <result column="birthday" jdbcType="DATE" property="birthday" />
    <result column="note" jdbcType="VARCHAR" property="note" />
    <result column="cardHold" jdbcType="VARCHAR" property="cardHold" />
  </resultMap>

  <select id="listMemberView" resultMap="MemberViewMap">
  	SELECT m.id,m.name,m.sex,m.phone,m.birthday,m.note, GROUP_CONCAT(card.`name` SEPARATOR ' | ') cardHold
	 FROM t_member m LEFT JOIN t_member_bind_record record ON m.id = record.member_id
	 LEFT JOIN t_member_card card ON card.id = record.card_id WHERE m.is_deleted = 0
	 GROUP BY m.id, m.name,m.sex,m.phone,m.birthday,m.note
  </select>

  <!-- 会员卡信息 -->
  <resultMap id="MemberCardViewMap" type="com.kclm.xsap.dto.MemberCardDTO">
  	<id column="id" jdbcType="BIGINT" property="bindCardId" />
    <result column="name" jdbcType="VARCHAR" property="name" />
    <result column="type" jdbcType="VARCHAR" property="type" />
    <result column="valid_count" jdbcType="INTEGER" property="totalCount" />
    <result column="create_time" jdbcType="TIMESTAMP" property="dueTime" />
    <result column="active_status" jdbcType="INTEGER" property="activeStatus" />
  </resultMap>

  <select id="listMemberCardView" resultMap="MemberCardViewMap">
  	SELECT card.id,card.`name`,card.`type`,bind.`valid_count`,bind.`create_time`,
     bind.`active_status` FROM t_member_card card LEFT JOIN
     t_member_bind_record bind ON card.`id` =
     bind.`card_id` WHERE card.`status` = 0 AND bind.`member_id` = #{memberId};
  </select>

  <!-- 预约记录 -->
  <resultMap id="reserveRecordMap" type="com.kclm.xsap.dto.ReserveRecordDTO">
  	<id column="id" jdbcType="BIGINT" property="reserveId" />
    <result column="course_name" jdbcType="VARCHAR" property="courseName" />
    <result column="create_time" jdbcType="TIMESTAMP" property="reserveTime" />
    <result column="card_name" jdbcType="VARCHAR" property="cardName" />
    <result column="order_nums" jdbcType="INTEGER" property="reserveNumbers" />
    <result column="times_cost" jdbcType="INTEGER" property="timesCost" />
    <result column="last_modify_time" jdbcType="TIMESTAMP" property="operateTime" />
    <result column="operator" jdbcType="VARCHAR" property="operator" />
    <result column="note" jdbcType="VARCHAR" property="reserveNote" />
    <result column="status" jdbcType="INTEGER" property="reserveStatus" />
  </resultMap>

  <select id="listReserveView" resultMap="reserveRecordMap">
  	SELECT reserve.id, course.name course_name, reserve.create_time, reserve.card_name, schedules.order_nums,
 course.times_cost, reserve.last_modify_time, reserve.operator, reserve.note, reserve.status
 FROM t_reservation_record reserve LEFT JOIN t_schedule_record schedules ON reserve.`schedule_id`
 = schedules.`id` LEFT JOIN t_course course ON schedules.course_id = course.id
 LEFT JOIN t_member_card card ON reserve.card_name = card.`name`
 WHERE card.`status` = 0 AND reserve.`member_id` = #{memberId};
  </select>

  <!-- 上课记录 -->
  <resultMap id="classRecordMap" type="com.kclm.xsap.dto.ClassRecordDTO">
  	<id column="id" jdbcType="BIGINT" property="classRecordId" />
    <result column="name" jdbcType="VARCHAR" property="courseName" />
    <result column="start_date" jdbcType="DATE" property="startDate" />
    <result column="class_time" jdbcType="TIME" property="startTime" />
    <result column="teacher_name" jdbcType="VARCHAR" property="teacherName" />
    <result column="card_name" jdbcType="VARCHAR" property="cardName" />
    <result column="order_nums" jdbcType="INTEGER" property="classNumbers" />
    <result column="times_cost" jdbcType="INTEGER" property="timesCost" />
    <result column="comment" jdbcType="VARCHAR" property="comment" />
    <result column="check_status" jdbcType="INTEGER" property="checkStatus" />
  </resultMap>

  <select id="listClassView" resultMap="classRecordMap">
  	SELECT class.id, course.name, schedules.start_date, schedules.class_time, schedules.order_nums,
 teacher.name teacher_name, class.card_name, course.times_cost, class.comment, class.check_status
 FROM t_class_record class LEFT JOIN t_schedule_record schedules ON
 class.`schedule_id` = schedules.id LEFT JOIN t_course course ON schedules.course_id = course.id
 LEFT JOIN t_employee teacher ON schedules.teacher_id = teacher.id LEFT JOIN t_member_card card
 ON class.card_name = card.`name`  WHERE card.`status` = 0
 AND class.`reserve_check` = 1 AND class.member_id = #{memberId};
  </select>


  <!-- 消费记录 -->
  <resultMap id="consumeRecordMap" type="com.kclm.xsap.dto.ConsumeRecordDTO">
  	<id column="id" jdbcType="BIGINT" property="consumeId" />
    <result column="member_bind_id" jdbcType="BIGINT" property="memberBindId" />
    <result column="name" jdbcType="VARCHAR" property="cardName" />
    <result column="create_time" jdbcType="TIMESTAMP" property="operateTime" />
    <result column="card_count_change" jdbcType="INTEGER" property="cardCountChange" />
    <result column="valid_count" jdbcType="INTEGER" property="timesRemainder" />
    <result column="money_cost" jdbcType="DECIMAL" property="moneyCost" />
    <result column="operate_type" jdbcType="VARCHAR" property="operateType" />
    <result column="operator" jdbcType="VARCHAR" property="operator" />
    <result column="note" jdbcType="VARCHAR" property="note" />
  </resultMap>

  <select id="listConsumeView" resultMap="consumeRecordMap">
  	SELECT consume.id, bind.`id` member_bind_id, card.`name`, consume.`create_time`, consume.`card_count_change`,
 bind.`valid_count`, consume.`money_cost`, consume.`operate_type`, consume.`operator`, consume.`note`
 FROM t_consume_record consume LEFT JOIN t_member_bind_record bind ON
 consume.`member_bind_id` = bind.`id` LEFT JOIN t_member_card card ON card.`id` = bind.`card_id`
 WHERE card.`status` = 0 AND bind.`member_id` = #{memberId}
  </select>

</mapper>
