<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X+约课系统 - 课程预约详情</title>
    <meta name="keywords" content="后台bootstrap框架,会员中心主题,后台HTML,响应式后台">
    <meta name="description" content="完全响应式，基于Bootstrap3最新版本开发的扁平化主题，她采用了主流的左右两栏式布局，使用了Html5+CSS3等现代技术">

    <link rel="shortcut icon" href="../../static/favicon.ico" th:href="@{/static/favicon.ico}">
    <link href="../../static/css/bootstrap.min.css?v=3.3.6" th:href="@{/static/css/bootstrap.min.css(v='3.3.6')}" rel="stylesheet">
    <link href="../../static/css/font-awesome.css?v=4.4.0" th:href="@{/static/css/font-awesome.css(v='4.4.0')}" rel="stylesheet">
    <link href="../../static/css/animate.css" th:href="@{/static/css/animate.css}" rel="stylesheet">
    <link href="../../static/css/style.css?v=4.1.0" th:href="@{/static/css/style.css(v='4.1.0')}" rel="stylesheet">
    <link href="../../static/css/plugins/dataTables/dataTables.bootstrap.css" th:href="@{/static/css/plugins/dataTables/dataTables.bootstrap.css}" rel="stylesheet">
    <!-- Morris -->
    <link href="../../static/css/plugins/morris/morris-0.4.3.min.css" th:href="@{/static/css/plugins/morris/morris-0.4.3.min.css}" rel="stylesheet">
    <link href="../../static/css/plugins/sweetalert/sweetalert.css" th:href="@{/static/css/plugins/sweetalert/sweetalert.css}" rel="stylesheet">
    <style>
        /*样式重写*/
        .ibox-content-2 {
            background-color: #ffffff;
            color: inherit;
            padding: 15px 20px 20px 20px;
            border-color: #e7eaec;
            -webkit-border-image: none;
            -o-border-image: none;
            border-image: none;
            border-style: solid solid none;
            border-width: 1px 0px;
            height: 270px;
        }

        .inmodal .modal-body {
            background: none;
        }

        .inmodal .modal-title {
            font-size: 17px;
            font-weight: bold;
        }

        .inmodal .modal-header {
            padding: 15px 15px;
            text-align: left;
        }

    </style>
</head>
<!--排课详情页面  by qikran-->
<body class="gray-bg">
<div class="wrapper wrapper-content animated fadeInRight">
    <!--上面内容-->
    <div class="row">
        <div class="col-lg-12">
            <div class="ibox float-e-margins">
                <div class="ibox-content-2 p-md">
                    <div class="col-md-5">
                        <div class="row">
                            <div class="col-sm12">
                                <h2><strong>钢琴专业课</strong></h2>
                            </div>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">开始时间:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="start_time">2020-05-31 15:32:05</span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">结束时间:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="end_titimeme">2020-06-31 15:32:05</span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">时长:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="">45<span>分钟</span></span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">限制性别:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="restrict_sex">全部</span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">限制年龄:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="restrict_age">不限</span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">支持会员卡:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="support_card">12课时一对一 96课时 24课时 48课时 12课时</span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">上课老师:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="teacher">上课老师</span>
                        </div>
                        <div class="row">
                            <label class="col-sm-3 text-navy">上课人数:</label>
                            <span class="col-sm-9 col-sm-pull-1" id="num">1/1<a data-toggle="modal"
                                                                                data-target="#updateNum"
                                                                                class="text-info">修改</a></span>
                        </div>
                    </div>
                    <div class="col-md-6 col-md-push-1 text-right">
                        <button class="btn btn-primary" data-toggle="modal" data-target="#addReservation">添加会员预约
                        </button>
                        <button id="exportData" class="btn btn-success">导出预约数据</button>
                        <!--<button id="delCourse" data-toggle="modal" data-target="#del" class="btn btn-danger">删除课程
                        </button>-->
                        <button id="delCourse" class="btn btn-danger  demo3">删除课程
                    </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--上面内容结束-->
    <!--标签栏-->
    <div class="row">
        <div class="col-sm-12">
            <div class="ibox float-e-margins">
                <div class="ibox-content p-md">
                    <div class="tabs-container">
                        <ul class="nav nav-tabs">
                            <li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true">已预约</a>
                            </li>
                            <li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false">预约记录</a>
                            </li>
                            <!-- add by yejf: 这里统计出当前计划时间的课 有哪些学员完成了上课 -->
                            <li class=""><a data-toggle="tab" href="#tab-3" aria-expanded="false">上课数据</a>
                            </li>

                        </ul>
                        <div class="tab-content">
                            <div id="tab-1" class="tab-pane active">
                                <div class="panel-body">
                                    <table class="table table-striped table-bordered table-hover dataTables-example">
                                        <thead>
                                        <tr>
                                            <th>会员</th>
                                            <th>手机号</th>
                                            <th>使用会员卡</th>
                                            <th>预约人数</th>
                                            <th>使用次数</th>
                                            <th>操作时间</th>
                                            <th>操作人</th>
                                            <th>预约来源</th>
                                            <th>预约备注</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="tab-2" class="tab-pane">
                                <div class="panel-body">
                                    <table class="table table-striped table-bordered table-hover dataTables-example-2">
                                        <thead>
                                        <tr>
                                            <th>会员</th>
                                            <th>手机号</th>
                                            <th>会员卡</th>
                                            <th>预约人数</th>
                                            <th>使用次数</th>
                                            <th>操作时间</th>
                                            <th>操作人</th>
                                            <th>预约来源</th>
                                            <th>预约结果</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <!--  end of tab2 -->

                            <div id="tab-3" class="tab-pane">
                                <div class="panel-body">
                                    <!-- 添加一个批理确认扣费按钮 -->
                                    <button class="btn btn-primary" id="deleteAll">批量确认</button>
                                    <table class="table table-striped table-bordered table-hover dataTables-example-3">
                                        <thead>
                                        <tr>
                                            <th><input type="checkbox" class="checkbox" id="selectAll"/> </th>
                                            <th>会员</th>
                                            <th>手机号</th>
                                            <th>会员卡</th>
                                            <th>性别</th>
                                            <th>年龄</th>
                                            <th>消费次数</th>
                                            <th>消费金额</th>
                                            <th>操作时间</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

        </div>


    </div>
    <!--标签栏结束-->
</div>

<!--模态窗-->

<!--修改人数模态窗-->
<div class="modal inmodal" id="updateNum" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <p class="modal-title">修改上课人数</p>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" name="updateNumForm" role="form">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">上课人数</label>
                        <div class="col-sm-5">
                            <input type="number" name="number" class="form-control" value="1">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" name="btnUpdate" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>
<!--添加会员预约窗-->
<div class="modal inmodal" id="addReservation" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content animated fadeIn">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span
                        class="sr-only">Close</span></button>
                <p class="modal-title">添加会员预约</p>
            </div>
            <div class="modal-body">
                <form class="form-horizontal" name="addReservation" role="form">
                    <div class="form-group">
                        <label class="col-sm-3 control-label">选择会员</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <input type="text" class="form-control" id="choseMember" placeholder="输入手机号或名字搜索">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-white dropdown-toggle" data-toggle="dropdown">
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-right" role="menu">
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">使用会员卡</label>
                        <div class="col-sm-8">
                            <select name="useCard" class="form-control">
                                <option value="">请选择绑定的会员卡</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">该会员卡</label>
                        <p class="col-sm-8" style="margin-top:7px">剩余<span id="remained">0</span>次,每节课每人收取<span
                                id="cost">0</span>次</p>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">预约人数</label>
                        <div class="col-sm-5">
                            <input type="number" name="reservationNum" class="form-control" value="1" required>
                        </div>
                        <span class="col-sm-3 text-left" style="margin-top:7px">总共使用<span id="spent">1</span>次</span>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">备注</label>
                        <div class="col-sm-8">
                            <textarea rows="3" name="description" class="form-control" placeholder="备注"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" name="btnAdd" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 上课扣费弹出框 -->
<div class="modal inmodal fade" id="details_deduction" tabindex="-1" role="dialog"  aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times</span><span class="sr-only">Close</span></button>
                <h4 class="modal-title">扣费</h4>
            </div>
            <div class="modal-body">
                <form method="get" class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">
                            扣除次数</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" placeholder="1" value="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">
                            扣除有效期</label>
                        <div class="col-sm-8">
                            <input type="number" class="form-control" placeholder="0">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">
                            备注</label>
                        <div class="col-sm-8">
                            <textarea class="col-sm-12 form-control" rows="5" placeholder="备注支付信息..."></textarea>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-white" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>
</div>
<!--模态窗结束-->

<!-- 全局js -->
<script src="../../static/js/jquery.min.js?v=2.1.4" th:src="@{/static/js/jquery.min.js(v='2.1.4')}"></script>
<script src="../../static/js/bootstrap.min.js?v=3.3.6" th:src="@{/static/js/bootstrap.min.js(v='3.3.6')"></script>
<!-- 自定义js -->
<script src="../../static/js/plugins/jeditable/jquery.jeditable.js" th:src="@{/static/js/plugins/jeditable/jquery.jeditable.js}"></script>
<script src="../../static/js/plugins/dataTables/jquery.dataTables.js" th:src="@{/static/js/plugins/dataTables/jquery.dataTables.js}"></script>
<script src="../../static/js/plugins/suggest/bootstrap-suggest.min.js" th:src="@{/static/js/plugins/suggest/bootstrap-suggest.min.js}"></script>

<script src="../../static/js/plugins/dataTables/dataTables.bootstrap.js" th:src="@{/static/js/plugins/dataTables/dataTables.bootstrap.js}"></script>
<script src="../../static/js/content.js?v=1.0.0" th:src="@{/static/js/content.js(v='1.0.0')}"></script>
<script src="../../static/js/plugins/sweetalert/sweetalert.min.js" th:src="@{/static/js/plugins/sweetalert/sweetalert.min.js}"></script>
<!--事件监听-->
<script>
    $(function () {
        $("button[name='btnUpdate']").click(function () {
            alert("提交");
            $("form[name='updateNumForm']").submit();
        });
        $("button[name='btnAdd']").click(function () {
            alert("提交");
            $("form[name='addReservation']").submit();
        });
        $("button[name='delCourse']").click(function () {
            alert("删除");
            $("#del").modal('toggle')
        });

        function getJsonData() {
            return [{
                "id": 1,
                "cardType": "12课时一对一"
            },
                {
                    "id": 2,
                    "cardType": "24课时"
                },
                {
                    "id": 3,
                    "cardType": "72课时"
                }
            ];
        }

        $("#choseMember").blur(function () {
            let val = $(this).val();
            let datas=getJsonData();//TODO 绑卡的静态数据
            let opHtml = "";
            /*选择的数据不为空时遍历数据,待修改（根据绑定关系修改）*/
            if (val!=null){
            for (let i in datas){
                opHtml += "<option value=\"" + datas[i].id + "\">" + datas[i].cardType + "</option>"
            }}
            
            $("select[name='useCard']").html(opHtml);
        });
        $("#exportData").click(function () {
            alert("导出数据");
        });
        var testdataBsSuggest = $("#choseMember").bsSuggest({
            indexId: 0,
            indexKey: 1,
            /*添加会员时，下拉框动态匹配的值*/
            //TODO 会员号的静态数据
            data: {
                'value': [
                    {    'id': '0',
                        'description': '1010250'
                    },
                    {     'id': '1',
                        'description': '2050133'
                    },
                    {
                        'id': '2',
                        'description': '3612334'
                    },
                    {
                        'id': '3',
                        'description': '1412341'
                    }
                    ,
                    {
                        'id': '4',
                        'description': '9652674'
                    }
                ]

            }
        });
    })
</script>
<script>
    /*标签一的表格*/
    $(document).ready(function () {
        $('.dataTables-example').dataTable({
            //TODO
            ajax: {
              url: "./demo-data/reservationData.json",
              dataSrc: ""
            },
            "columns":[
                {"data": "username"},
                {"data": "phone"},
                {"data": "userCard"},
                {"data": "orderNum"},
                {"data": "useTimes"},
                {"data": "operateTime"},
                {"data": "operateName"},
                {"data": "source"},
                {"data": "note"},
                {"data": null,"render": function (data,type,row) {
                        var html = "<button  class='btn btn-warning cancel_btn'>取消预约</button>&nbsp &nbsp";
                        return html;
                    }
                }
            ],
            "fnDrawCallback": function () {
                //给复选框添加事件
                console.log("绘制完表格后...");
                $('.cancel_btn').click(function () {
                    swal({
                        title: "您确定要取消本次预约吗？",
                        text: "注意:如果当天取消预约超过2次，则当前不能再次预约了",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "确认",
                        closeOnConfirm: false
                    }, function () {
                        swal("取消预约成功！", "","success");
                    });
                });
            },
            "bSort": false,
            "searching": true,
            "pagingType": "full_numbers",
            "bLengthChange": false,
            "info": false,
        });
    });
    /*标签二的表格*/
    $(document).ready(function () {
        $('.dataTables-example-2').dataTable({
            //TODO
            ajax: {
                url: "./demo-data/reservationRecord.json",
                dataSrc: ""
            },
            "columns":[
                {"data": "username"},
                {"data": "phone"},
                {"data": "userCard"},
                {"data": "orderNum"},
                {"data": "useTimes"},
                {"data": "operateTime"},
                {"data": "operateName"},
                {"data": "source"},
                {"data": "result"}
            ],
            "autoWidth": false,  //禁用自动宽度
            "bSort": false,
            "searching": true,
            "pagingType": "full_numbers",
            "bLengthChange": false,
            "info": false
        });
    });

    /*标签三的表格*/
    $(document).ready(function () {
        $('.dataTables-example-3').dataTable({
            //TODO
            ajax: {
                url: "./demo-data/teacherClassRecord.json",
                dataSrc: ""
            },
            "columns":[
                {"data": null, "render": function (data,type,row) {
                        //在回传的JSON中，要有真正的ID值
                        return "<input type='checkbox' class='checkbox' name='classDataIds' value='"+row.id+"'/>";
                    }
                },
                {"data": "username"},
                {"data": "phone"},
                {"data": "memberCard"},
                {"data": "sex"},
                {"data": "age"},
                {"data": "useTimes"},
                {"data": "amountMoney"},
                {"data": "operateTime"},
                {"data": "status", "render": function (data, type, row) {
                        //此处要使用 row 来获取当前被渲染的行的数据
                        if(row.status == '未确认') {
                            return "<span class='label label-warning'>"+row.status+"</span>"
                        } else  {
                            return "<span class='label label-success'>"+row.status+"</span>";
                        }
                    }},
                {"data": null, "render": function (data, type, row) {
                        //此处进行判断后，再决定是否要激按钮
                        if(data.status == '未确认') {
                            return "<button  class='btn btn-primary btn-xs' data-toggle='modal' data-target='#details_deduction'>确认扣费</button>";
                        } else {
                            return "<button  class='btn btn-default btn-xs' disabled>确认扣费</button>";
                        }
                    }
                }
            ],
            "autoWidth": false,  //禁用自动宽度
            "bSort": false,
            "searching": false,
            "pagingType": "full_numbers",
            "bLengthChange": false,
            "info": false
        });
    });

    $(function () {
        $('.demo3').click(function () {
            swal({
                title: "您确定要删除该课程么",
                text: "注意:删除课程后，预约的会员将全部取消，消耗的次卡将退回至会员的会员卡",
                type: "warning",
                showCancelButton: true,
                confirmButtonColor: "#DD6B55",
                confirmButtonText: "删除",
                closeOnConfirm: false
            }, function () {
                swal("删除成功！", "","success");
            });
        });

        //给全选 复选框添加事件
        $("#selectAll").change(function () {
            //选出所有的复选框【不含 #select-all】
            $(":checkbox").not("#selectAll").prop("checked", $("#selectAll").prop("checked"));
        });

        //2. 给删除所选  按钮添加 单击事件
        $("#deleteAll").click(function () {
            //定义一个变量来保存是否有 选中的复选框
            var isSelect = false;
            //定义 一个变量来存储用户选中的复选框 的值
            var queryData = "";   //格式是： key=value1&key=value2&key=value3
            var datas = [];
            //针对所有的复选框进行迭代
            $(":checkbox").not("#selectAll").each(function (index, item) {
                isSelect = isSelect || $(item).prop("checked");
                // 只要是被选中的，就取出它的值
                if ($(item).prop("checked")) {
                    queryData = (queryData + "flags=" + $(item).val() + "&");
                    //
                    datas.push($(item).val());
                }
            });
            //把queryData中的最后一个 & 给删除掉
            queryData = queryData.substring(0, queryData.length - 1);
            //
            console.log(queryData);
            //把数组转换成 json 字符串
            var datasJson = JSON.stringify(datas);
            console.log(datasJson);

            //判断
            if (!isSelect) {
                //说明没有选中任何一个
                alert("至少要选中一个");
            } else {
                //说明有选中，继续提示真的要删除吗
                if (confirm("确定要批量确认会员扣费吗？")) {
                    //执行删除操作 ... 使用 ajax 来发送异步删除的请求
                    $.ajax({
                        //url: "${pageContext.request.contextPath}/book/deleteSelect.do?"+queryData,
                        url: appName + "/xxxx.do",
                        method: "post",
                        data: datasJson,
                        async: true,
                        dataType: "text",   //表示期望服务端返回给我们的数据格式
                        contentType: "application/json",  //客户端给服务端的格式
                        success: function (data) {
                            //成功
                            alert(data);
                            //重新加载本页面
                            window.location.reload();
                        },
                        error: function (jqXHR) {
                            // 失败
                            alert("删除失败了");
                        }
                    });
                }
            }
        }); //
    });
</script>

</body>

</html>
